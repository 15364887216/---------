# 存储器
我们说过现代计算机以**存储器**为中心，这一章我们就要具体研究存储器的种类以及相关的工作原理。
![总结](/image/1/review1.png)
这一节我们通过逐步完善一个思维导图的方式来进行记忆。
要研究存储器我们首先就需要知道他们的种类。
## 存储器的分类
### 按层次分类
![huawei](/image/3/huawei.png)
我们需要对存储器的类型有一个基本的认知，在这张手机的购买页面中，我们总会发现有类似（**12GB+512GB**）的字样，我们总会听人说12是运行内存，512是“内存”；小时候打游戏可能会碰到运行内存不足的说法，可打开Windows的磁盘管理器，**明明还有好几个G！**这样的说法在计算机组成原理中不常用，也不够严谨。

我们说的12GB是主存，512GB是辅存，凭生活经验我们知道**辅存**往往比**主存大得多**。
以下是主存和辅存的定义：

#### 主存
**主存**（Main Memory），也称为**内存**，是计算机系统中的一种高速存储器。它用于存放当前正在运行的程序和数据，**供中央处理器（CPU）直接访问**。主存的特点是存取速度快，但容量相对较小。常见的主存类型包括动态随机存取存储器（DRAM）和静态随机存取存储器（SRAM）.

#### 辅存
**辅存**（Secondary Storage），也称为**外存**或**辅助存储器**，是指计算机系统中的外部存储设备，如硬盘、固态硬盘（SSD）、光盘、U盘等。辅存的特点是存储容量大、成本低、存取速度相对较慢，并且可以在断电后长期保存数据。辅存主要用于存储大量的程序和数据，**供主存调用**.

知道他们的关系后我们可以得到这么一张图：
![层次](/image/3/cengci.png)
```
主存和cpu的工作完全由硬件进行,辅存到主存的工作需要操作系统的调度。
```
有人会问图里的Cache是什么东西？我们先按下不表，先来看一张图来说明他们为什么是这样的层次。
![三星内存条](/image/3/sanxing.png)
这是一条16GB的三星内存条，装在电脑上很明显增多的是它的**主存（或内存）**，图上可以看到它在读，写，复制的速率以及延迟。它的读写速度都大约在**4GB（4096MB）** 左右，它与cpu直接相连由硬件直接进行数据传输。

假设一个CPU的时钟频率为3.5GHz（即每秒3.5亿个时钟周期），而内存的访问时间为70纳秒（即每秒约1400万次访问）。我们可以看到，**CPU处理数据的速度远远快于内存传输的速度**。

我们在生活中会发现一个手机游戏比如**王者荣耀**，这类游戏的“内存”动不动就好几个GB，仅仅一个手机游戏就要占这么多，更别说还有其他数据，更何况电脑的存储空间往往比手机大的多，很显然，**主存放不下！**

计算机中存储的大量数据并不都是需要cpu进行处理的，你不用它的时候，它就静静躺在那里，我们不能让不用的数据放在主存里**占着茅坑不拉屎**，所以需要一个辅助存储空间来放他们，只有在需要他们的时候才会转移到主存中，这就是**辅存**。

而前面我们知道主存和cpu处理数据的速度事实上有很大差距，我们可以采用**cache（高速缓冲存储器）** 来作为二者的中间人，相比之下他有**更小的存储空间与更快的处理速度**，这样可以缓解cpu因为没有数据处理导致的cpu闲置问题。

综上，我们会根据数据传输速率和存储空间得到这么一个金字塔型的图片。
![层次](/image/3/cengci1.png)
当然因为制作复杂程度和材料等的关系价格也呈现这样一个趋势。
![层次](/image/3/思维导图/1.png)

### 按存储介质分类
对于计算机来说数据就是简单的0和1，所以有很多种物理手段可以保存和表示他们，高低电平，正负磁极，光介质，我们根据存储的介质可以分为：
- 半导体存储器（**主存和cache**）
- 光存储器（如光盘）
- 磁表面存储器（如磁带，磁盘）

**主存（内存）和缓存（Cache）使用半导体存储器**的原因主要有以下几点：

#### 1. 高速访问
半导体存储器，如SRAM（静态随机存取存储器）和DRAM（动态随机存取存储器），具有非常快的访问速度。SRAM通常用于缓存，因为它的访问时间在1到10纳秒之间，而DRAM用于主存，访问时间在50到100纳秒之间¹²。这种高速访问能力使得CPU可以更快地读取和写入数据，从而提高系统的整体性能。

#### 2. 随机访问
半导体存储器支持随机访问，这意味着可以在任何时间点直接访问存储器中的任意位置，而不需要按顺序读取。这对于需要频繁访问不同数据位置的计算机系统来说是非常重要的。

#### 3. 集成度高
半导体存储器可以集成到芯片中，体积小且功耗低。SRAM和DRAM都可以在较小的物理空间内提供大量的存储容量，这对于现代计算机系统的紧凑设计非常重要。

#### 4. 稳定性和可靠性
半导体存储器具有较高的稳定性和可靠性。SRAM使用晶体管来存储数据，具有较长的使用寿命和较低的故障率。虽然DRAM需要定期刷新以保持数据，但它的结构简单，制造成本低，适合大规模应用。

#### 数据示例
- **SRAM（用于缓存）**：访问时间约为1到10纳秒，适合存储频繁访问的数据。
- **DRAM（用于主存）**：访问时间约为50到100纳秒，适合存储大量数据。

通过使用半导体存储器，计算机系统能够在性能、功耗和成本之间取得良好的平衡，从而实现高效的数据处理和存储。

```
一个简单的区分方法，半导体存储器就是主存和cache，其他介质的都是辅存
```
之后我们会研究各种存储器的工作原理，之后会讲。
![层次](/image/3/思维导图/2.png)

### 按存取方式分类
![层次](/image/3/cqfs.png)
存储器按存取方式可以分为以下几类：随机存储器（RAM）、只读存储器（ROM）、串行访问存储器和直接存取存储器。以下是它们的定义和工作原理：

#### 1. 随机存储器（RAM, Random Access Memory）
**定义**：RAM是一种可以随机访问任何存储单元的存储器，存取时间与存储单元的物理地址无关。它分为静态RAM（SRAM）和动态RAM（DRAM）。

**工作原理**：
- **SRAM**：使用触发器（flip-flop）来存储每一位数据，具有高速访问的特点，但成本较高，功耗较大，通常用于缓存（Cache）。
- **DRAM**：使用电容存储数据，需要定期刷新以保持数据，成本较低，存储密度高，通常用于主存（内存）。

#### 2. 只读存储器（ROM, Read Only Memory）
**定义**：ROM是一种只能读取而不能写入的存储器，存储内容在制造时或通过特定方法写入后不可更改。

**工作原理**：
- **ROM**：存储内容在制造时写入，适用于存储固件和不需要更改的数据。
- **PROM**：可编程只读存储器，用户可以一次性写入数据。
- **EPROM**：可擦除可编程只读存储器，可以通过紫外线擦除数据并重新编程。
- **EEPROM**：电可擦除可编程只读存储器，可以通过电信号擦除和编程，常用于存储配置数据。

#### 3. 串行访问存储器（Serial Access Memory）
**定义**：串行访问存储器在读/写操作时需要按物理位置的先后顺序进行访问。

**工作原理**：
- **磁带存储器**：数据存储在磁带上，读写时必须从介质的起始位置开始顺序查找，适用于大容量数据的顺序存取。
- **顺序存取存储器**：如磁带，不论信息处于什么位置，读写时都从介质的始端顺序查找。

#### 4. 直接存取存储器（Direct Access Memory）
**定义**：直接存取存储器可以直接访问存储单元，不需要按顺序查找。

**工作原理**：
- **磁盘存储器**：数据存储在磁盘上，可以直接访问特定的磁道和扇区，存取时间取决于数据块的位置和大小，适用于需要频繁随机访问的大容量数据存储。

#### 应用场景
- **RAM**：用于计算机的主存（内存），存储操作系统、应用程序和正在处理的数据。
- **ROM**：用于存储计算机的BIOS、手机的操作系统和预装应用程序。
- **串行访问存储器**：用于磁带存储和一些移动设备中，适合顺序访问的大数据量存储。
- **直接存取存储器**：用于硬盘、光盘等存储设备，适合需要频繁随机访问的场景。

### 其他分类
![层次](/image/3/kggx.png)
![层次](/image/3/kbcx.png)

### 结构梳理
![层次](/image/3/思维导图/4.png)
我们知道**计算机 = 硬件 + 软件**，最基本的软件就是**操作系统**，我们需要与操作系统有一定的知识交叉。

前面说过**主存和cache**都是**半导体存储器**，它们需要频繁地随机读写数据，因此主存和cache是**随机存储器**（同时也是读写存储器），电脑断电以后会数据丢失，可知**主存和cache**都是**易失性存储器。**

RAM根据工作原理特性分为***SRAM（静态存储器）***和***DRAM（动态存储器）***，分别用于主存和cache，由于主存需要写回辅存，所以读出后不能被破坏，因此是SRAM。cache作为主存和cpu数据交换的临时中转站，需要保持高速传输很容易丢失，所以是DRAM。

内存（主存）（一般指电脑**内存条**）包含RAM（SRAM,DRAM），ROM,高速缓存（CACHE）,SDRAM,DDRRAM。

而操作系统之类的东西一般不能被更改，要写在ROM中。
![层次](/image/3/思维导图/3.png)
![层次](/image/3/思维导图/fl.png)

# 主存储器的基本组成
这里为了理解我们继续采用计算机科学速成课的内容，而不是王道408。
****
在硬件层面，计算机的数据就是最简单的0和1，那么有没有什么办法能保持1或0的数据呢？
我们知道存储器就是用来存储数据的，但它是怎么做到的？它怎么能做到存那么多数据？
我们需要从最简单的数字电路开始先理解如何能锁住1bit的二进制数字。
## 锁存器
锁存器（Latch）是一种基本的存储单元电路，用于在数字电路中存储一个位的信息。它的工作原理主要基于控制信号的状态来决定是否改变输出状态。

1.回路门
![](/image/3/锁存器/1.png)

我们将or门的输出与其中一条输入相连，初始状态他们都是0，当线路A为高电平，即1时，or输出为1，此时B恒为1.之后我们无论做什么，或门都会一直保持输出为1的状态，我们锁住了**一位1**信号。

![](/image/3/锁存器/2.png)

相同的原理，与门与或门相反，锁住的是0信号。

2.AND-OR锁存器

![](/image/3/锁存器/3.png)

我们将上面两条电路结合起来。我们存在两条线路，分别为**置1端（set）**和**置0端（reset）**，如果我们使set变为1，则锁住信号1，如果使reset变为1，则锁住信号1。当然**同时为1时也会为0，而在同时为0时则取决于前一刻该锁存器状态的输出。**

3.门锁

![](/image/3/锁存器/4.png)

AND-OR锁存器有两条输入，我们还需要分析哪一条线路是要打开的，虽然可以存储数据，但是对现在动不动几十上百G的内存显然超级麻烦！另外我们也需要明确，**计算机中不是所有内存都要工作**，因此我们可以将两条输入通过加一些电路的方法变为一条**输入线**，再增加一条管理锁存器开关的**允许写入线**。

![](/image/3/锁存器/5.png)

现在我们可以忽视电路细节并对它进行一层**封装！**
```
计算机的组成就是不断封装的过程，学习它的过程就像在玩一个俄罗斯套娃，你可以一个一个合上它，也可以一步一步拆开他。
```

## 寄存器
我们将得到的能锁住1bit数据的电路称为**门锁**，我们之前接触过一些**锁存器**，比如MAR（存储地址寄存器）和MDR（存储数据寄存器）。
理解主存前我们可以先了解一下寄存器的构造，我们知道MDR存储的位数等于计算机的**机器字长**，也就是我们嘴里说的32或64位计算机的处理位数。

***
1. **指令字长**：
   - 指令字长是指一条指令中包含的二进制代码的位数。它取决于操作码的长度、操作数地址的个数和长度³。
   - 指令字长可以等于、少于或多于机器字长。

2. **机器字长**：
   - 机器字长是指计算机一次能直接处理的二进制数据的位数，通常等于内部寄存器的大小。
   - 例如，64位计算机的机器字长就是64位。

3. **操作字长**：
   - 操作字长通常指的是操作数的长度，即计算机在一次操作中能处理的二进制数据的位数。
   - 它可以与机器字长相同，也可以不同，具体取决于计算机的设计和指令集架构³。

***
和主存上百G的容量比，显然MDR的32位要小得多！听起来好像**只要把门锁串起来好像就可以**，对，你没说错。

![](/image/3/寄存器/1.png)
我们计算机最早使用的8bit寄存器就是这么做的，将所有的**允许线**连接起来，为对应的**输入线**输入0或1就可以存到指定的门锁中，这样我们就可以存储8位的数据啦！
现在寄存器依旧在CPU的内部存在，是CPU可以读写的最快的存储器。

## 内存
有了寄存器的基础我们其实可以很粗糙地做出我们需要的内存，但显然存在一个问题，**线路**，一个门锁要有一根允许写入线，一根输入线，一根输出线。8bit还好，随着位数的增加我们的线路也会越来越复杂，即便允许写入线全部连起来，按我们之前的想法，64位的存储器就要129根线!还涉及到布线和门锁的排列等因素。
```
关于线路的问题会在总线系统中涉及到。
```
## 门锁矩阵
为了解决上面说过的问题，我们可以采用门锁矩阵的方式：
![](/image/3/寄存器/2.png)
如图，我们可以看到一个256bit的门锁矩阵，一个16*16的矩阵，当我们想为指定的锁存器存储时，只需要打开对应的**行线**和**列线**。

我们可以放大来看具体的电路细节是怎么做的：
![](/image/3/寄存器/3.png)
现在需要明白的是我们不仅需要写入这些数据，还需要读出，我们在实现内存时显然不能和寄存器一样让所有的内存都去输出，所以我们需要增加**允许读取线（write enable）**。

我们可以通过对应的**行线**和**列线**来控制**允许写入线**和**允许读取线**，整个矩阵只需要一条写入线和一条读取线就可以把整个矩阵链接起来，而我们只需要一个小小的and门就可以控制数据写入与读取的位置。

同样的，因为整个矩阵只有一个锁存器会被打开，因此只需要**一条数据写入线**就可以把他们全部连起来！

在这个矩阵中，我们只需要**16条行线，16条列线，数据写入线、允许读取线和允许写入线各一条**共计**35条**就可以解决整个电路的写入和读取。
```
和之前的思路对比，35条比513条线路要少得多，降低了线路复杂度，这很省钱！
```
## 256位内存
仅仅上面的门锁矩阵还不够，因为涉及到了我们**地址**的概念，总共256个寄存器，如果用二进制地址表示我们需要2^8^,即00000000 ~ 11111111，假设前4位对应行线，后4位对应列线，我们如何通过地址来选择对应的行线？

### 多路复用器
答案是多路复用器
![](/image/3/MTX.png)
4位地址的每一个数字对对应一条行线。
****
使用多路复用器后的效果是这样的：
![](/image/3/寄存器/4.png)

我们现在可以对这个矩阵再进行一次封装！它暴露在外的线现在只有11条了。
![](/image/3/寄存器/5.png)
```
关于线路的数量是一道经典考题，这块建议多看。
```
## RAM
内存的一个重要特性是：可以随时访问任何位置，因此叫 “随机存取存储器” ，简称 **RAM**。（内存就是随机存取存储器）
8 个 256 位的内存并排放置：
- 一行 8 个，可以存一个 8 bit数字，也就是一个字节
- 为了存一个 8 bit的数字，同时给 8 个 256 位内存一样的地址
- 每个存 1 bit，意味着可以在 256 个地址 存 256 个字节
  
![](/image/3/RAM/1.png)
不看作一堆单独的存储和电路，看做一个统一的可寻址的内存
- 一共有 256 个地址
- 每个地址可以读写一个 8 bit（也就是 1 字节）的值

![](/image/3/RAM/2.png)
***
现代计算机的内存 扩展到上兆字节（MB）和千兆字节（GB）的方式，和这里一样不断把内存打包到更大规模，随着内存地址增多，内存地址也必须增长，8 位最多能代表 256 个内存地址（1111 1111 是255，0~255 一共 256 个数字）,要给千兆或十亿字节的内存寻址，需要 32 位的地址

这是一条真实的内存，上面焊了8个内存模块

![](/image/3/RAM/3.png)
打开其中一个放大看到32个内存方块
![](/image/3/RAM/4.png)
放大其中一个方块，可以看到由 4 个小块组成
![](/image/3/RAM/5.png)
再放大可以看到存单个bit的矩阵，这是一个 128×64 bit的矩阵，总共 8192 bit
![](/image/3/RAM/6.png)
```
32 个内存方块每个都有 4 个矩阵，所以一个方格有 32768 个位 （8192 x 4 = 32768），而一共 32 个方格，一个芯片大约存 800 万位，一共 8 个芯片，所以总共有 800 万位，也就是 1 兆字节（1 MB），这是1980年代的RAM
```
##  基本的半导体元件及其原理
还记得第一章的内容吗？我们的逻辑元件经历了电子管->晶体管->集成电路的发展经历：
![硬件发展历史](/image/1/image1.png) 
MOS管就是我们内存常用的晶体管，一般大量集成为集成电路使用：
![](/image/3/MOS.png)
我们之前使用数字逻辑电路模拟了一下锁存器到内存的集成过程，这里的MOS管和前面的锁存器一样可以存储一位数字，集成方式是相同的。

物理原理：
MOS管（MOSFET）存储一位数据的基本原理主要依赖于电容的充放电过程。以下是一个简化的解释：

1. **存储单元结构**：一个典型的存储单元由一个MOS管和一个电容组成。
2. **数据存储**：
   - **存储“1”**：当MOS管的栅极加上高电压时，MOS管导通，电容被充电，存储电荷。这时，电容上有电压，表示存储了“1”。
   - **存储“0”**：当MOS管的栅极电压为低时，MOS管截止，电容放电，没有电荷。这时，电容上没有电压，表示存储了“0”¹²³.

这种方式利用了电容的充放电特性来表示二进制数据的“1”和“0”。

##  存储器芯片的基本原理
![](/image/3/主存储器和CPU的连接.png)
在之前我们通过**多路复用器**实现了地址与寄存器的绑定，我们可以联系前面的学习，cpu中的**CU（控制单元）**，发出控制信号控制读写连接主存的读控制线和写控制线，就像下面的图片一样。
![](/image/3/RAM/1.png)
![](/image/3/ccqxp1.png)
我们知道多路复用器可以通过地址写到指定的寄存器，他们处于一个多对1的关系。那问题来了，地址怎么得出？我们用01表示地址，因此我们需要一个n：2^n^的**译码器**，通过上图我们指定MAR中存储了3位数字，我们可以通过译码器变为8位的地址（我们前面说过MAR的最大值可以表示最大寻址单元的数量，即总共有多少个地址）。
![](/image/3/ccqxp2.png)
将他们抽象为上图后我们发现有一个**片选线**，现在我们用官方语言来总结一下这些线的作用：
- 存储矩阵是由一个一个的存储元构成；

- 译码驱动电路分为译码器和驱动器，译码器会输出某一条线路的高电平信号，驱动器是为了保证译码器输出的高电平稳定可靠的，可以理解为将电信号放大的部件。

- 读写电路是连通存储元的电路

- 地址线：用来读取和写入数据，接收地址信息，通常是CPU通过地址总线传来的

- 数据线：实现数据的传输，其位数与芯片可读出或写入的数据位数有关

- 片选线：**传输芯片选择信号或者芯片使能信号，用来选择存储芯片**

- 读写控制线：可以一条，可能有两条 
两条： 
$\overline {WE}$表示允许写； 
$\overline {OE}$表示允许读 
一条： $\overline {WE}$表示低电平写，高电平读

每个存储芯片都对外有金属引脚，用来接收地址信号，数据信号，片选信号，读写信号，每条地址线、数据线、片选线以及读写控制线都会对应一个金属的引脚
![](/image/3/ccqxp3.png)
前面说过我们一个内存条有好几个内存方块，一个内存方块可能有好几个内存芯片，片选线的作用就是选择指定的**内存芯片**并传递信号。

## SRAM和DRAM
双稳态触发器和栅极电容是两种不同的存储单元技术，分别用于SRAM（静态随机存取存储器）和DRAM（动态随机存取存储器）中。

### 双稳态触发器（SRAM）
- **结构**：由6个MOS管组成的双稳态电路。
- **工作原理**：利用两个互补的MOS管对来存储一个比特的数据。每个触发器有两个稳定状态，分别表示二进制的0和1。
- **特点**：
  - **速度快**：由于不需要刷新，读写速度较快。
  - **稳定性高**：数据在电源不断的情况下可以长期保持。
  - **功耗高**：由于需要持续供电以维持数据。
  - **成本高**：由于结构复杂，制造成本较高，集成度较低.

### 栅极电容（DRAM）
- **结构**：由一个MOS管和一个电容组成。
- **工作原理**：通过电容的充放电来存储数据。电容充电表示1，放电表示0。
- **特点**：
  - **速度较慢**：由于需要定期刷新以保持数据，读写速度较慢。
  - **功耗低**：相比SRAM，功耗较低。
  - **成本低**：结构简单，制造成本较低，集成度较高。
  - **需要刷新**：电容存储的电荷会随时间泄漏，因此需要定期刷新以保持数据.

### 应用场景
- **SRAM**：由于速度快和稳定性高，常用于**CPU缓存**等对速度要求高的场景。
- **DRAM**：由于成本低和集成度高，常用于**计算机主存**等需要大量存储空间的场景。

之前我们讲的内存就是**DRAM**，原因前面说过了，我们区分存储器类型最主要的就是看他们的电路类型，是否断电会影响数据，读写速度是否较快，能否读写。

## 寻址
1 B = 8 bit,矩阵中一行8位，也就是1B，即1个字节。一个int型就是一个字，即4B，以此类推
![](/image/3/xz.png)
![](/image/3/xz1.png) 

# ROM
![](/image/3/ROM/1.png) 
![](/image/3/ROM/2.png) 
![](/image/3/ROM/3.png) 
![](/image/3/ROM/4.png) 
![](/image/3/ROM/5.png) 
![](/image/3/ROM/6.png) 
ROM没啥好说的，看PPT记住应用就好。